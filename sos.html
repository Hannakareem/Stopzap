<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOS Emergency Alert</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            margin: 0;
            font-family: "Inter", sans-serif;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(-45deg,
                    #0f172a,
                    #1e1b4b,
                    #312e81,
                    #0f172a);
            background-size: 500% 500%;
            animation: gradientBG 12s ease infinite;
            overflow: hidden;
            color: white;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .card {
            background: rgba(30, 41, 59, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.12);
            padding: 35px;
            border-radius: 18px;
            text-align: center;
            width: 90%;
            max-width: 420px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 35px rgba(0, 0, 0, 0.4);
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        p {
            color: #cbd5e1;
            font-size: 0.95rem;
        }

        input {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: none;
            margin: 15px 0;
            font-size: 1rem;
            outline: none;
        }

        #save-btn {
            width: 100%;
            padding: 14px;
            border-radius: 14px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            background: #22c55e;
            color: white;
            transition: 0.3s;
        }

        #save-btn:hover {
            background: #16a34a;
        }

        #sos-btn {
            width: 100%;
            padding: 16px;
            margin-top: 20px;
            font-size: 1.1rem;
            font-weight: 800;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            color: white;
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            box-shadow: 0 0 18px rgba(239, 68, 68, 0.6);
            transition: 0.3s ease;
            animation: sosPulse 1.5s infinite;
        }

        #sos-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 35px rgba(239, 68, 68, 1);
        }

        #sos-btn:active {
            transform: scale(0.95);
        }

        @keyframes sosPulse {
            0% {
                box-shadow: 0 0 12px rgba(239, 68, 68, 0.5);
            }

            50% {
                box-shadow: 0 0 40px rgba(239, 68, 68, 1);
            }

            100% {
                box-shadow: 0 0 12px rgba(239, 68, 68, 0.5);
            }
        }

        #status {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #facc15;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: #F8FAFC;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            text-decoration: none;
        }

        .back-btn:hover {
            background: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.5);
        }
    </style>
</head>

<body>

    <a href="index.html" class="back-btn">‚Üê Back</a>

    <div class="card">
        <h1>üö® SOS Emergency Alert</h1>
        <p>Your emergency contact is ready. Press SOS to send DANGER alert with your live location and nearest police station.</p>

        <!-- Emergency Contact Info -->
        <div id="contact-info" style="display: none; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); padding: 15px; border-radius: 12px; margin-bottom: 20px; color: #10B981;">
            <p style="color: #10B981; font-size: 13px; margin: 0;">‚úÖ Emergency contact saved:</p>
            <p id="saved-contact" style="font-size: 14px; font-weight: 600; margin: 5px 0 0 0;"></p>
        </div>

        <!-- No Contact Saved Message -->
        <div id="no-contact-message" style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); padding: 15px; border-radius: 12px; margin-bottom: 20px; color: #EF4444;">
            <p style="color: #EF4444; font-size: 13px; margin: 0;">‚ö†Ô∏è No emergency contact saved</p>
            <p style="font-size: 14px; margin: 8px 0 0 0;">Please go back to the landing page to save your emergency contact first.</p>
            <a href="index.html" style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #EF4444; text-decoration: none; border-radius: 6px; font-size: 12px; font-weight: 600;">‚Üê Back to Landing</a>
        </div>

        <!-- SOS Button -->
        <button id="sos-btn">üö® SEND SOS NOW</button>

        <p id="status">Waiting...</p>
    </div>

    <!-- Alarm Sound -->
    <audio id="alarm-sound"
        src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
        preload="auto" loop></audio>

    <script>
        /* ‚úÖ Load and display saved contact on page load */
        window.addEventListener('load', () => {
            const savedContact = localStorage.getItem('emergencyContact');
            const savedContactData = localStorage.getItem('emergency_contact');
            const contactInfo = document.getElementById('contact-info');
            const noContactMessage = document.getElementById('no-contact-message');

            if (savedContact && savedContactData) {
                // Show saved contact info
                const contactData = JSON.parse(savedContactData);
                document.getElementById('saved-contact').innerHTML = 
                    `${contactData.name} (${contactData.relation})<br><small>${contactData.phone}</small>`;
                contactInfo.style.display = 'block';
                noContactMessage.style.display = 'none';
                document.getElementById('status').innerText = '‚úÖ Emergency contact ready!';
            } else {
                // No saved contact - show message to go to landing page
                contactInfo.style.display = 'none';
                noContactMessage.style.display = 'block';
                document.getElementById('status').innerText = 
                    '‚ö†Ô∏è Please save your emergency contact on the landing page first';
            }
        });


        /* üö® SOS Button */
        document.getElementById("sos-btn").addEventListener("click", async () => {

            let savedNumber = localStorage.getItem("emergencyContact");
            let savedContactData = localStorage.getItem("emergency_contact");

            if (!savedNumber) {
                alert("‚ùå No emergency contact saved!");
                return;
            }

            // Disable button to prevent multiple clicks
            document.getElementById("sos-btn").disabled = true;
            document.getElementById("status").innerText = "üìç Fetching live location...";

            navigator.geolocation.getCurrentPosition(async (pos) => {

                let lat = pos.coords.latitude;
                let lon = pos.coords.longitude;
                let accuracy = pos.coords.accuracy;
                let timestamp = new Date().toLocaleString();

                let liveLink = `https://maps.google.com/?q=${lat},${lon}`;

                /* üöì Find Nearest Police Station */
                let policeName = "Locating nearest police station...";
                let policeDistance = "Unknown";

                try {
                    document.getElementById("status").innerText = "üöì Finding nearest police station...";
                    
                    let url =
                        `https://overpass-api.de/api/interpreter?data=[out:json];node(around:2000,${lat},${lon})["amenity"="police"];out;`;

                    let res = await fetch(url);
                    let data = await res.json();

                    if (data.elements.length > 0) {
                        policeName = data.elements[0].tags.name || "Police Station";
                        // Calculate approximate distance
                        let policeNode = data.elements[0];
                        let policieLat = policeNode.lat;
                        let policeLon = policeNode.lon;
                        let distance = calculateDistance(lat, lon, policieLat, policeLon);
                        policeDistance = distance + " km away";
                    }

                } catch (error) {
                    console.error("Police station lookup failed:", error);
                    policeName = "Police station location server error";
                }

                /* Get contact name if available */
                let contactName = "Emergency Contact";
                if (savedContactData) {
                    try {
                        const contactData = JSON.parse(savedContactData);
                        contactName = contactData.name;
                    } catch (e) {}
                }

                /* üì≤ Enhanced Emergency Message */
                let emergencyMsg =
                    `üö® EMERGENCY ALERT! üö®\n\n` +
                    `‚ö†Ô∏è DANGER! ${contactName} needs help immediately!\n` +
                    `Status: IN SERIOUS DANGER\n` +
                    `Time: ${timestamp}\n\n` +
                    `üìç LIVE LOCATION:\n${liveLink}\n` +
                    `Coordinates: ${lat.toFixed(4)}, ${lon.toFixed(4)}\n` +
                    `Accuracy: ¬±${Math.round(accuracy)} meters\n\n` +
                    `üöì NEAREST POLICE STATION:\n${policeName}\n${policeDistance}\n\n` +
                    `‚ö° PRIORITY: HIGH\n` +
                    `Please respond and contact emergency services immediately!\n\n` +
                    `Sent from: Stopzap Emergency Alert System`;

                /* SMS Message (shorter version) */
                let smsMsg =
                    `EMERGENCY ALERT! ${contactName} is in danger!\n` +
                    `Location: ${liveLink}\n` +
                    `Police: ${policeName}\n` +
                    `Respond immediately! From Stopzap`;

                document.getElementById("status").innerText = "üì§ Preparing to send emergency alert...";

                // Show confirmation dialog
                const sendVia = confirm(
                    `üö® EMERGENCY ALERT üö®\n\n` +
                    `Send SOS to: ${contactName}\n\n` +
                    `Choose transmission method:\n` +
                    `OK = WhatsApp (recommended, more reliable)\n` +
                    `CANCEL = SMS Text Message\n\n` +
                    `Press OK or CANCEL to continue`
                );

                if (sendVia) {
                    // Send via WhatsApp
                    document.getElementById("status").innerText = "üì≤ Opening WhatsApp...";
                    window.open(
                        `https://wa.me/${savedNumber}?text=${encodeURIComponent(emergencyMsg)}`
                    );
                } else {
                    // Send via SMS
                    document.getElementById("status").innerText = "üìû Opening SMS...";
                    window.location.href = `sms:${savedNumber}?body=${encodeURIComponent(smsMsg)}`;
                }

                /* üîä Play Alarm */
                try {
                    const alarmSound = document.getElementById("alarm-sound");
                    alarmSound.play().catch(e => console.log("Autoplay prevented:", e));
                } catch (e) {
                    console.log("Alarm play error:", e);
                }

                /* Log SOS event */
                const sosHistory = JSON.parse(localStorage.getItem('sos_history') || '[]');
                sosHistory.push({
                    timestamp: timestamp,
                    contact: contactName,
                    phone: savedNumber,
                    location: `${lat},${lon}`,
                    policeStation: policeName
                });
                localStorage.setItem('sos_history', JSON.stringify(sosHistory));

                document.getElementById("status").innerText =
                    "‚úÖ SOS SENT! Authorities and emergency contact alerted!";

                // Keep button disabled for 3 seconds
                setTimeout(() => {
                    document.getElementById("sos-btn").disabled = false;
                }, 3000);

            },
                (error) => {
                    document.getElementById("status").innerText =
                        "‚ùå GPS access denied! Enable location permissions.";
                    document.getElementById("sos-btn").disabled = false;
                    console.error("Geolocation error:", error);
                });

        });

        /* Calculate distance between two coordinates (Haversine formula) */
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c).toFixed(1);
        }
    </script>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">

</body>

</html>
